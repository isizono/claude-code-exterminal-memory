---
name: sync_memory
description: セッション終了前にtranscriptを解析し、トピック・決定事項・タスク・仕様書を一括で記録・更新する
---

# sync_memory

このセッションの会話内容（transcript）を解析し、以下の記録・更新を**すべて実行**してください。

## 実行手順

### 0. 既存データの確認（重複防止）

**最初に必ず実行する。** 前回のsync_memoryやセッション中の手動記録で既に記録されている可能性があるため、既存データを確認してから記録する。

**アクション:**
- セッション中に使ったトピックの `get_decisions(topic_id=...)` を実行し、直近の決定事項を取得
- `get_tasks(project_id=..., status="pending")` で未完了タスクを取得
- 取得した既存データと会話内容を照合し、**既に記録済みの内容は記録しない**

**重複の判定基準:**
- 同じ意味・内容のdecisionが既にあれば記録しない（完全一致でなくても意味が同じならスキップ）
- 同じタイトル・目的のtaskが既にあれば記録しない
- 同じテーマのtopicが既にあれば記録しない

### 1. トピックの特定・作成 (add_topic)

transcriptを解析し、議論されたテーマを特定する。

**チェック項目:**
- 新しい議論テーマが出ていないか？
- 既存トピックの子トピックとして切り出すべきものはないか？
- トピックが広すぎて分割すべきものはないか？

**アクション:**
- 新しいテーマがあれば `add_topic` で作成
- 親子関係がある場合は `parent_topic_id` を設定

### 2. 決定事項の記録 (add_decision)

合意が成立した内容をすべて記録する。

**決定事項の判定基準:**
- ユーザーが「OK」「それでいこう」「了解」「いいね」等で承認した
- AIの提案に対して明示的な同意があった
- 「〜で決定」「〜に決めた」等の表現がある

**チェック項目:**
- 記録漏れの決定事項はないか？
- 各決定事項は適切なトピックに紐づいているか？
- decision と reason が明確に分離されているか？

**アクション:**
- 未記録の決定事項があれば `add_decision` で記録
- `topic_id` は関連するトピックを指定

### 3. タスクの登録 (add_task)

実装予定・作業予定をすべて登録する。

**タスクの判定基準:**
- 「〜を実装する」「〜を作る」「〜を追加する」
- 「〜が必要」「〜をやる」
- 決定事項から派生する実装作業

**チェック項目:**
- 記録漏れのタスクはないか？
- タスクの粒度は適切か？（1つのPRで完結する程度）
- description に十分な情報があるか？

**アクション:**
- 未登録のタスクがあれば `add_task` で登録
- 関連する仕様書があれば description に参照を含める

### 4. 未決定の論点を記録 (add_decision)

議論が途中で終わった論点・アイデア・検討事項を記録する。**決定していなくても記録する**。

**記録すべきもの:**
- 議論に出たが結論が出ていない論点
- 「〜かも」「〜という案もある」「〜どうしようかな」
- 提案されたが承認/却下がまだのアイデア
- 次のセッションで継続すべき検討事項

**チェック項目:**
- 議論が途中で終わっている論点はないか？
- 出てきたアイデアが記録されずに消えていないか？

**アクション:**
- `add_decision` で記録（決定事項と同じテーブルで管理）
- **プレフィックスをつける**: `[議論中]` または `[未完]`
- フォーマット例:
  ```
  decision: "[議論中] Skillの発動条件をどう改善するか（選択肢: A案, B案, C案）"
  reason: "議論は出たが結論未定。次セッションで継続"
  ```
- 論点が大きい場合は子トピックとして切り出す

### 5. 未完の作業をタスクとして登録 (add_task)

セッション中に途中で終わった話・作業がある場合、次のセッションで**このタスクだけ見れば文脈が取れる**レベルでタスクを登録する。

**対象:**
- 議論が途中で終わった話題（設計の途中、要件の詰めが途中など）
- 実装に着手したが完了していない作業
- ユーザーから依頼されたが未着手のもの

**タスクの書き方:**
- title: `[未完] 〜` のプレフィックスをつける
- description に**文脈を多めに**記載する。具体的には：
  - 何について話していたか
  - どこまで進んだか・何が決まったか
  - 何が残っているか・次に何をすべきか
  - 関連するトピックID・決定事項ID

**フォーマット例:**
```
title: "[未完] sync_memoryに未完タスク自動作成機能を追加"
description: "topic_id:135で議論中。ステップ4のdecision記録はそのまま残し、追加でadd_taskでも登録する方針で合意済み（decision A案）。残作業：SKILL.mdへのステップ追加と動作確認。"
```

**注意:**
- ステップ4の `[未完]` decision とは別に、タスクとしても登録する（役割が異なる：decisionは「何が未決定か」、taskは「次に何をすべきか」）
- 未完の話がなければこのステップはスキップする

### 6. pendingタスクの棚卸し

ステップ0で取得したpendingタスク一覧を精査し、不要なタスクの削除をユーザーに提案する。

**判断基準（4カテゴリ）:**

1. **完了済み**: PRマージ済み、機能が既に実装されているなど、目的が達成されているタスク
2. **重複**: 同じ目的・内容のタスクが複数存在する場合の片方
3. **7日以上放置**: `created_at` から7日以上経過しているpendingタスク
4. **状況変化で不要**: 前提条件が変わり、もうやる意味がないタスク

**手順:**

1. pendingタスクを上記4カテゴリに分類する
2. カテゴリごとにAskUserQuestionで削除を提案する
3. ユーザーが承認したタスクを `update_task_status(task_id, "completed")` で完了にする

**「7日以上放置」で残したいと言われた場合:**
- 古いタスクを `completed` にする
- 最新の文脈で新しいタスクを `add_task` で作成する（古い記述は腐っている可能性が高いため）

**提案フォーマット（カテゴリごとに提示）:**
```
### 完了済み（X件）
- id:XXX タイトル → 理由（例: PR#77でマージ済み）
- id:XXX タイトル → 理由
→ これらを完了にしていい？
```

**注意:**
- 該当タスクがなければこのステップはスキップする
- 判断に迷うものは提案しない（誤って消すより残すほうが安全）

## 7. 完了報告

以下の形式でサマリーを報告:

```
## sync_memory 完了

### トピック
- 作成: X件
- (作成したトピック名を列挙)

### 決定事項
- 記録: X件
- (記録した決定事項の概要を列挙)

### タスク
- 登録: X件
- (登録したタスク名を列挙)

### 未決定の論点
- 記録: X件
- (記録した論点の概要を列挙)

### 未完の作業タスク
- 登録: X件
- (登録したタスク名と概要を列挙)

### タスク棚卸し
- 完了にしたタスク: X件
- 作り直したタスク: X件
- (処理したタスクを列挙)

### 注意事項
- (もしあれば、確認が必要な事項や曖昧な点を記載)
```

## 注意

- **ログ (add_log) は記録しない** - セッション中にエージェントが都度記録するため
- **未決定の論点は add_decision で記録する** - プレフィックス `[議論中]` `[未完]` をつけて区別
- 判断に迷う場合は、記録する方向で進める（後で修正可能）
- **既に記録済みのものは重複して記録しない** - ステップ0で取得した既存データと照合すること
- **現在進行中の作業がある場合は `add_task` で登録し、`update_task_status` で `in_progress` にする**
- **ステップ1〜6ではツール呼び出しの前後に判断理由・中間分析・進捗報告のテキストを出力しない。ユーザーに見せるのはステップ6のAskUserQuestion（該当タスクがある場合）とステップ7の完了報告のみ**
