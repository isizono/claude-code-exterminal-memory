---
description: セッション終了前にtranscriptを解析し、トピック・決定事項・タスク・仕様書を一括で記録・更新する
---

# sync_memory

このセッションの会話内容（transcript）を解析し、以下の記録・更新を**すべて実行**してください。

## 実行手順

### 0. 既存データの確認（重複防止）

**最初に必ず実行する。** Stopフックのsync_memory.py（3ターンごと自動）が既に記録している可能性があるため、既存データを確認してから記録する。

**アクション:**
- セッション中に使ったトピックの `get_decisions(topic_id=...)` を実行し、直近の決定事項を取得
- `get_tasks(project_id=..., status="pending")` で未完了タスクを取得
- 取得した既存データと会話内容を照合し、**既に記録済みの内容は記録しない**

**重複の判定基準:**
- 同じ意味・内容のdecisionが既にあれば記録しない（完全一致でなくても意味が同じならスキップ）
- 同じタイトル・目的のtaskが既にあれば記録しない
- 同じテーマのtopicが既にあれば記録しない

### 1. トピックの特定・作成 (add_topic)

transcriptを解析し、議論されたテーマを特定する。

**チェック項目:**
- 新しい議論テーマが出ていないか？
- 既存トピックの子トピックとして切り出すべきものはないか？
- トピックが広すぎて分割すべきものはないか？

**アクション:**
- 新しいテーマがあれば `add_topic` で作成
- 親子関係がある場合は `parent_topic_id` を設定

### 2. 決定事項の記録 (add_decision)

合意が成立した内容をすべて記録する。

**決定事項の判定基準:**
- ユーザーが「OK」「それでいこう」「了解」「いいね」等で承認した
- AIの提案に対して明示的な同意があった
- 「〜で決定」「〜に決めた」等の表現がある

**チェック項目:**
- 記録漏れの決定事項はないか？
- 各決定事項は適切なトピックに紐づいているか？
- decision と reason が明確に分離されているか？

**アクション:**
- 未記録の決定事項があれば `add_decision` で記録
- `topic_id` は関連するトピックを指定

### 3. タスクの登録 (add_task)

実装予定・作業予定をすべて登録する。

**タスクの判定基準:**
- 「〜を実装する」「〜を作る」「〜を追加する」
- 「〜が必要」「〜をやる」
- 決定事項から派生する実装作業

**チェック項目:**
- 記録漏れのタスクはないか？
- タスクの粒度は適切か？（1つのPRで完結する程度）
- description に十分な情報があるか？

**アクション:**
- 未登録のタスクがあれば `add_task` で登録
- 関連する仕様書があれば description に参照を含める

### 4. 未決定の論点を記録 (add_decision)

議論が途中で終わった論点・アイデア・検討事項を記録する。**決定していなくても記録する**。

**記録すべきもの:**
- 議論に出たが結論が出ていない論点
- 「〜かも」「〜という案もある」「〜どうしようかな」
- 提案されたが承認/却下がまだのアイデア
- 次のセッションで継続すべき検討事項

**チェック項目:**
- 議論が途中で終わっている論点はないか？
- 出てきたアイデアが記録されずに消えていないか？

**アクション:**
- `add_decision` で記録（決定事項と同じテーブルで管理）
- **プレフィックスをつける**: `[議論中]` または `[未完]`
- フォーマット例:
  ```
  decision: "[議論中] Skillの発動条件をどう改善するか（選択肢: A案, B案, C案）"
  reason: "議論は出たが結論未定。次セッションで継続"
  ```
- 論点が大きい場合は子トピックとして切り出す

## 5. 完了報告

以下の形式でサマリーを報告:

```
## sync_memory 完了

### トピック
- 作成: X件
- (作成したトピック名を列挙)

### 決定事項
- 記録: X件
- (記録した決定事項の概要を列挙)

### タスク
- 登録: X件
- (登録したタスク名を列挙)

### 未決定の論点
- 記録: X件
- (記録した論点の概要を列挙)

### 注意事項
- (もしあれば、確認が必要な事項や曖昧な点を記載)
```

## 注意

- **ログ (add_log) は記録しない** - Stopフックで自動記録されるため
- **未決定の論点は add_decision で記録する** - プレフィックス `[議論中]` `[未完]` をつけて区別
- 判断に迷う場合は、記録する方向で進める（後で修正可能）
- **既に記録済みのものは重複して記録しない** - ステップ0で取得した既存データと照合すること。Stopフックのsync_memory.pyが3ターンごとに自動記録しているため、特にdecisionsとtasksの重複に注意
- **現在進行中の作業がある場合は `add_task` で登録し、`update_task_status` で `in_progress` にする**
