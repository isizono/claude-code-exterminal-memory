# Stopフックによる会話記録の自動化 - 仕様書

## 1. 概要

### 目的
- 毎ターンの会話（ユーザー発言 + AI応答）を自動でログに記録する
- エージェントが記録を忘れる問題を解決する
- トピック変更時に決定事項の記録漏れを防ぐ

### 背景
- 従来: CLAUDE.mdにadd_log呼び出しを指示 → 忙しいと忘れがち
- 新方式: Stopフックで強制的に記録 + メタタグ出力を強制

## 2. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    Claude Code セッション                     │
│                                                             │
│  ユーザー発言 → AI応答 → Stop発火                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                     Stopフック (Bash)                        │
│                                                             │
│  入力JSON:                                                  │
│  - session_id                                               │
│  - transcript_path                                          │
│  - stop_hook_active                                         │
│                                                             │
│  処理フロー:                                                 │
│  1. stop_hook_active=true → approve（無限ループ防止）        │
│  2. メタタグチェック → なければblock                          │
│  3. トピック変更チェック → 前topicにdecisionなければblock     │
│  4. approve + バックグラウンドでログ記録                      │
└─────────────────┬───────────────────────────────────────────┘
                  │ バックグラウンド
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                  ログ記録処理 (Python)                        │
│                                                             │
│  1. transcriptから直近1リレーを抽出                          │
│  2. claude --model haiku で要約                             │
│  3. service層でadd_log()                                    │
└─────────────────────────────────────────────────────────────┘
```

## 3. メタタグ仕様

### フォーマット
```html
<!-- [meta] project: {project_name} (id: {project_id}) | topic: {topic_title} (id: {topic_id}) -->
```

**注**: HTMLコメント形式で出力することで、ユーザーには見えないがhookでパース可能。

### ルール
- AIは毎ターンの応答の最後にメタタグを出力する
- Stopフックでメタタグがなければblockされる
- トピックが変わった場合は新しいtopic_idを出力する

## 4. 1リレーの定義

### 判定ロジック

| エントリタイプ | type | toolUseResult |
|--------------|------|---------------|
| 人間のユーザー発言 | `user` | なし |
| ツール結果 | `user` | あり |
| AI応答 | `assistant` | - |

### 1リレーの範囲
```
[Human User] → [Assistant]* → ([Tool Result] → [Assistant])* → [次のHuman User]
```

人間のユーザー発言から、次の人間のユーザー発言の直前までが1リレー。

## 5. Stopフック処理詳細

### 入力JSON（stdin）
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../session.jsonl",
  "stop_hook_active": true
}
```

### 処理フロー

1. **無限ループ防止**: `stop_hook_active=true` の場合は即座にapprove
2. **メタタグチェック**: 直近のassistant応答に`[meta]`タグがなければblock
3. **トピック変更チェック**: 前回と異なるtopic_idの場合、前トピックにdecisionがなければblock
4. **現在のトピックを保存**: `/tmp/claude_prev_topic_{session_id}` に記録
5. **ログ記録**: バックグラウンドでログ記録処理を起動し、approveを返す

## 6. ログ記録処理詳細

### 処理フロー

1. **直近1リレーの抽出**: transcriptファイルから人間のユーザー発言〜次の人間発言直前までを取得
2. **要約生成**: claude CLIでHaikuモデルを使い、リレー内容を要約
3. **DB保存**: service層の`add_log()`でデータベースに保存

### 要約フォーマット
```
ユーザー: 〇〇と言った / AI: △△と考え、□□と応答した
```

## 7. 設定ファイル

### rulesファイル（メタタグ出力ルール）

配置場所: `~/.claude/rules/meta-tag.md`

AIに対してメタタグ出力を強制するルールを記述する。

### hooks設定

配置場所: `.claude/settings.json`

Stopイベントに対してstop_hook.shを実行するよう設定する。

## 8. SessionStartフック仕様

### 目的
セッション開始時にAIへ未決定トピックのコンテキストを渡す。

### 処理内容
- 全プロジェクト横断で未決定トピックをN件取得
- 取得した情報をAIへのメッセージとして出力
